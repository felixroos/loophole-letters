---
title: Trying FAUST on the Web
description: ""
date: "2023-09-06"
tags: ["code"]
draft: true
---

Let's play with FAUST on the web. The repo [@grame/faustwasm](https://www.npmjs.com/package/@grame/faustwasm) has different export options. I chose:

```sh
node scripts/faust2wasm.js test/rev.dsp test/out -standalone
```

This generates a html page with a UI to control a reverb effect + mic input. It loads `dspModule.wasm` for the audio processing.

It might be really handy if the package.json of faustwasm had a `bin` field, which would allow using the tool without cloning the repo, just by using npx.

## Loading FAUST with Web Audio

I was able to condense a quick setup to this:

```js
import dspModuleUrl from "./reverb/dspModule.wasm?url";
import dspMeta from "./reverb/dspMeta.json";
import { FaustMonoDspGenerator } from "@grame/faustwasm";

const loadFaustReverb = async (ac) => {
  const module = await WebAssembly.compileStreaming(fetch(dspModuleUrl));
  const generator = new FaustMonoDspGenerator();
  const node = await generator.createNode(ac, "FaustMonoDSP", {
    module,
    json: JSON.stringify(dspMeta),
  });
  node.connect(ac.destination);
  return node;
};
```

(This will only work on vite, but replacing the dspModule path with a public path should also work anywhere else)

To test the reverb, let's load a test sample:

```js
async function loadClapBuffer(ac) {
  const res = await fetch(
    "https://raw.githubusercontent.com/tidalcycles/Dirt-Samples/master/cp/HANDCLP0.wav"
  );
  const buffer = await res.arrayBuffer();
  const audioBuffer = await ac.decodeAudioData(buffer);
  return audioBuffer;
}
```

Now let's connect it together:

```js
async function play() {
  const ac = new AudioContext();
  const reverb = await loadFaustReverb(ac);

  const source = ac.createBufferSource();
  source.buffer = await loadClapBuffer(ac);
  source.connect(reverb);
  source.start();
}
```

import { FaustReverb } from "../../components/faust/Faust.jsx";

This is how it sounds like:

<FaustReverb client:only />

The next question would be how the parameters can be controlled from the outside..

## Working With Params

This is the API to work with params:

```js
const reverb = await loadFaustReverb(ac);
const params = reverb.getParams();
// ['/Freeverb/0x00/Damp', '/Freeverb/0x00/RoomSize', '/Freeverb/0x00/Stereo_Spread', '/Freeverb/Wet']
const damp = reverb.getParamValue("/Freeverb/0x00/Damp"); // 0.5
reverb.setParamValue("/Freeverb/0x00/Damp", 0.75);
```

We could convert params to an object like this:

```js
const getParams = (faustNode) =>
  Object.fromEntries(
    faustNode.getParams().map((key) => [key, faustNode.getParamValue(key)])
  );
console.log(getParams(reverb));
/* 
{ 
  '/Freeverb/0x00/Damp': 0.5, 
  '/Freeverb/0x00/RoomSize': 0.5, 
  '/Freeverb/0x00/Stereo_Spread': 0.5, 
  '/Freeverb/Wet': 0.33 
}
*/
```

... which should be enough to spin up a UI!
